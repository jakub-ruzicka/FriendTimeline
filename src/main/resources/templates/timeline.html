<!doctype html>
<html lang="cs" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timeline</title>
    <link rel="stylesheet" href="/css/timeline.css" />
</head>

<body>
<header class="topbar">
    <a class="topbar__back" href="/">← Zpět</a>
    <h1 class="topbar__title">Naše timeline</h1>
</header>

<main class="timeline" id="timeline"
      th:attr="data-count=${#lists.size(entries)}">

    <!-- Background pattern is done via CSS on body/timeline -->

    <section class="timeline__stage" id="stage" aria-label="Timeline stage">
        <svg class="snake" id="snakeSvg"
             xmlns="http://www.w3.org/2000/svg"
             preserveAspectRatio="none"
             aria-hidden="true">
            <path id="snakePath" class="snake__path" d=""></path>
            <g id="snakeDots" class="snake__dots"></g>
        </svg>

        <!-- Labels rendered/positioned by JS -->
        <div class="labels" id="labels" aria-hidden="false"></div>

        <!-- Data for JS (rendered by Thymeleaf) -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            window.TIMELINE_ENTRIES = /*[[${entries}]]*/ [];
            /*]]>*/
        </script>

        <!-- Hidden accessible list (screen readers + fallback) -->
        <ol class="sr-list" aria-label="Milníky">
            <li th:each="e, stat : ${entries}"
                th:attr="id=${'item-' + stat.index}">
                <button type="button"
                        class="sr-list__btn"
                        th:attr="data-index=${stat.index}"
                        th:text="${#temporals.format(e.datumFotky, 'd.M.yyyy')} + ' — ' + ${e.popis}">
                    item
                </button>
            </li>
        </ol>
    </section>
</main>

<!-- Modal -->
<div class="modal" id="modal" hidden>
    <div class="modal__backdrop" data-close="backdrop"></div>

    <div class="modal__dialog"
         role="dialog"
         aria-modal="true"
         aria-labelledby="modalTitle"
         aria-describedby="modalDesc"
         tabindex="-1">
        <button class="modal__close" type="button" aria-label="Zavřít" data-close="x">×</button>

        <div class="modal__content">
            <div class="modal__media">
                <img id="modalImg" alt="" />
                <div class="modal__imgFallback" id="modalImgFallback" hidden>Image not found</div>
            </div>

            <div class="modal__text">
                <div class="modal__date" id="modalTitle">—</div>
                <p class="modal__desc" id="modalDesc"></p>
            </div>
        </div>
    </div>
</div>

<script src="/js/timeline.js" defer></script>
</body>
</html>
(function () {
    "use strict";

    const entries = Array.isArray(window.TIMELINE_ENTRIES) ? window.TIMELINE_ENTRIES : [];

    const stage = document.getElementById("stage");
    const svg = document.getElementById("snakeSvg");
    const path = document.getElementById("snakePath");
    const dotsGroup = document.getElementById("snakeDots");
    const labelsLayer = document.getElementById("labels");

    const modal = document.getElementById("modal");
    const modalDialog = modal?.querySelector(".modal__dialog");
    const modalImg = document.getElementById("modalImg");
    const modalImgFallback = document.getElementById("modalImgFallback");
    const modalTitle = document.getElementById("modalTitle");
    const modalDesc = document.getElementById("modalDesc");

    let activeIndex = null;
    let lastFocus = null;

    function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
    }

    function toIsoDateString(value) {
        if (value == null) return "";
        if (typeof value === "string") return value;

        if (typeof value === "object") {
            const y = value.year;
            const m = value.monthValue ?? value.month;
            const d = value.dayOfMonth ?? value.day;

            if (Number.isInteger(y) && Number.isInteger(m) && Number.isInteger(d)) {
                const mm = String(m).padStart(2, "0");
                const dd = String(d).padStart(2, "0");
                return `${y}-${mm}-${dd}`;
            }
        }
        return String(value);
    }

    function formatDate(input) {
        const iso = toIsoDateString(input);
        const d = new Date(iso + "T00:00:00");
        if (Number.isNaN(d.getTime())) return String(iso);
        return new Intl.DateTimeFormat("cs-CZ", { day: "2-digit", month: "2-digit", year: "numeric" }).format(d);
    }

    function setStageHeight() {
        const n = Math.max(entries.length, 1);

        const isMobile = window.matchMedia("(max-width: 720px)").matches;
        const topPad = isMobile ? 90 : 120;
        const bottomPad = isMobile ? 120 : 160;
        const spacing = isMobile ? 140 : 180;

        const height = topPad + (n - 1) * spacing + bottomPad;
        stage.style.height = `${Math.max(height, Math.floor(window.innerHeight * 0.70))}px`;
        return { topPad, bottomPad, spacing, height: Math.max(height, Math.floor(window.innerHeight * 0.70)) };
    }

    function buildSnakePath(viewW, viewH) {
        const cx = viewW * 0.50;
        const amp = viewW * 0.22;
        const segments = 10;
        const segH = viewH / segments;

        let d = `M ${cx} 0`;
        for (let i = 0; i < segments; i++) {
            const y0 = i * segH;
            const y1 = (i + 1) * segH;

            const dir = i % 2 === 0 ? 1 : -1;
            const x1 = cx + amp * dir;

            const cp1x = cx + amp * dir;
            const cp1y = y0 + segH * 0.25;
            const cp2x = cx + amp * dir;
            const cp2y = y0 + segH * 0.75;

            d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x1} ${y1}`;
        }
        return d;
    }

    function clearChildren(el) {
        while (el.firstChild) el.removeChild(el.firstChild);
    }

    function createLabel(index, xPx, yPx) {
        const e = entries[index];
        const label = document.createElement("div");
        label.className = "label";
        label.style.left = `${xPx}px`;
        label.style.top = `${yPx}px`;

        const side = index % 2 === 0 ? 1 : -1;
        const dx = side === 1 ? 18 : -18;
        label.style.transform = `translate(${dx}px, -50%)`;

        const pill = document.createElement("button");
        pill.className = "label__pill";
        pill.type = "button";
        pill.dataset.index = String(index);
        pill.setAttribute("aria-label", `Otevřít fotku pro datum ${formatDate(e.datumFotky ?? e.datum_fotky ?? "")}`);
        pill.textContent = formatDate(e.datumFotky ?? e.datum_fotky ?? "");

        label.appendChild(pill);

        // Popis necháme pryč v timeline (zobrazí se až v modalu)
        return label;
    }

    function positionMilestones() {
        if (!stage || !svg || !path || !dotsGroup || !labelsLayer) return;

        const rect = stage.getBoundingClientRect();
        const stageW = rect.width;
        const stageH = rect.height;

        const viewW = 1000;
        const viewH = Math.max(600, Math.floor(stageH * 1.0));

        svg.setAttribute("viewBox", `0 0 ${viewW} ${viewH}`);
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");

        path.setAttribute("d", buildSnakePath(viewW, viewH));

        const total = path.getTotalLength();
        const n = entries.length;

        // Dots group necháme prázdný (žádná kolečka)
        clearChildren(dotsGroup);
        clearChildren(labelsLayer);

        for (let i = 0; i < n; i++) {
            const t = n === 1 ? 0.5 : i / (n - 1);
            const tSafe = clamp(t, 0.02, 0.98);
            const point = path.getPointAtLength(total * tSafe);

            const xPx = (point.x / viewW) * stageW;
            const yPx = (point.y / viewH) * stageH;

            labelsLayer.appendChild(createLabel(i, xPx, yPx));
        }
    }

    function openModal(index, { pushHash = true } = {}) {
        if (!modal || !modalDialog || !modalImg || !modalTitle || !modalDesc) return;
        if (!entries[index]) return;

        activeIndex = index;

        const e = entries[index];
        const filename = e.nazevFotky ?? e.nazev_fotky ?? "";
        const iso